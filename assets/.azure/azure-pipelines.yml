trigger:
    branches:
        include:
            - main
            - stage

variables:
    containerImage: 'ghcr.io/enabel/pipeline-php:8.4'
    vmImageName: 'ubuntu-24.04'
    rootFolder: $(System.DefaultWorkingDirectory)
    phpVersion: 8.4
    mysqlVersion: 8.0
    redisVersion: 7
    DATABASE_URL: "mysql://app:!ChangeMe!@database:3306/app?serverVersion=$(mysqlVersion)&charset=utf8mb4"
    REDIS_URL: 'redis://redis:6379'
    XDEBUG_MODE: coverage

resources:
    containers:
        - container: main
          image: $(containerImage)
        - container: database
          image: mysql:$(mysqlVersion)
          env:
              MYSQL_DATABASE: app
              MYSQL_USER: app
              MYSQL_PASSWORD: "!ChangeMe!"
              MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          ports:
              - 3306:3306
          healthcheck:
              test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
              timeout: 5s
              retries: 5
              start_period: 60s
        - container: redis
          image: redis:$(redisVersion)
          ports:
              - 6379:6379
          healthcheck:
              test: [ "CMD", "redis-cli" ,"ping" ]
              timeout: 10s
              retries: 10
              start_period: 60s

stages:
    - stage: Build
      displayName: Build source
      jobs:
          - job: BuildJob
            container: main

            services:
                redis: redis
                database: database

            steps:
                - script: php -version
                  displayName: 'VÃ©rifier version PHP'

                - script: composer validate --no-check-publish
                  workingDirectory: $(rootFolder)
                  displayName: 'Composer validate'

                - script: composer install --prefer-dist --no-progress --optimize-autoloader
                  workingDirectory: $(rootFolder)
                  displayName: 'Composer install'

                - script: php bin/console asset-map:compile --env=prod
                  workingDirectory: $(rootFolder)
                  displayName: 'Build assets'

                - task: CopyFiles@2
                  displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
                  inputs:
                      SourceFolder: '$(rootFolder)'
                      Contents: |
                          **/*
                          !.git/**
                          !var/log/*.log
                      TargetFolder: '$(Build.ArtifactStagingDirectory)'

                - task: ArchiveFiles@2
                  displayName: 'Archive files'
                  inputs:
                      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
                      includeRootFolder: false
                      archiveType: zip
                      archiveFile: $(Build.ArtifactStagingDirectory)/Build-$(Build.SourceBranchName)-$(Build.BuildId).zip
                      replaceExistingArchive: true

                - task: PublishPipelineArtifact@1
                  displayName: 'Upload build'
                  inputs:
                      targetPath:
                          $(Build.ArtifactStagingDirectory)/Build-$(Build.SourceBranchName)-$(Build.BuildId).zip
                      artifactName:
                          drop

    - stage: Security
      displayName: Check security
      dependsOn: Build
      jobs:
          - job: security_check
            container: main
            displayName: 'Dependencies security check'
            steps:
                - checkout: none

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download package'
                  inputs:
                      artifactName: drop
                      path: $(System.ArtifactsDirectory)

                - task: ExtractFiles@1
                  displayName: 'Extract files'
                  inputs:
                      archiveFilePatterns: '$(System.ArtifactsDirectory)/Build-$(Build.SourceBranchName)-$(Build.BuildId).zip'
                      destinationFolder: '$(rootFolder)'
                      cleanDestinationFolder: true

                - script: symfony check:security
                  displayName: 'Security checker'

    - stage: CodingStandards
      displayName: Check coding standards
      dependsOn: Build
      jobs:
          - job: coding_standards
            pool:
                vmImage: $(vmImageName)
            services:
                redis: redis
                database: database
            displayName: 'Coding standards check'
            steps:
                - checkout: none

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download package'
                  inputs:
                      artifactName: drop
                      path: $(System.ArtifactsDirectory)

                - task: ExtractFiles@1
                  displayName: 'Extract files'
                  inputs:
                      archiveFilePatterns: '$(System.ArtifactsDirectory)/Build-$(Build.SourceBranchName)-$(Build.BuildId).zip'
                      destinationFolder: '$(rootFolder)'
                      cleanDestinationFolder: true

                - script: composer install --prefer-dist --no-progress --optimize-autoloader
                  workingDirectory: '$(rootFolder)/tools/php-cs-fixer'
                  displayName: 'PHPCsFixer install'

                - script: tools/php-cs-fixer/vendor/bin/php-cs-fixer fix --dry-run --diff
                  displayName: 'Run PHPCsFixer'

                - script: composer install --prefer-dist --no-progress --optimize-autoloader
                  workingDirectory: '$(rootFolder)/tools/phpstan'
                  displayName: 'PHPStan install'

                - script: tools/phpstan/vendor/bin/phpstan analyse
                  displayName: 'Run PHPStan'

          - job: linters
            container: main
            services:
                redis: redis
                database: database
            displayName: 'Linters check'
            steps:
                - checkout: none

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download package'
                  inputs:
                      artifactName: drop
                      path: $(System.ArtifactsDirectory)

                - task: ExtractFiles@1
                  displayName: 'Extract files'
                  inputs:
                      archiveFilePatterns: '$(System.ArtifactsDirectory)/Build-$(Build.SourceBranchName)-$(Build.BuildId).zip'
                      destinationFolder: '$(rootFolder)'
                      cleanDestinationFolder: true

                - script: symfony console cache:warmup
                  displayName: 'Warmup cache'

                - script: symfony console lint:container
                  displayName: 'Lint container configuration files'

                - script: symfony console doctrine:schema:validate --skip-sync -v --no-interaction
                  displayName: 'Lint doctrine configuration files'

                - script: symfony console lint:twig templates
                  displayName: 'Lint twig files'

                - script: symfony console lint:yaml config --parse-tags
                  displayName: 'Lint yaml files'

    - stage: Tests
      displayName: Run tests
      dependsOn: Build
      jobs:
          - job: testing
            container: main
            services:
                redis: redis
                database: database
            displayName: 'Run tests suite'
            steps:
                - checkout: none

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download package'
                  inputs:
                      artifactName: drop
                      path: $(System.ArtifactsDirectory)

                - task: ExtractFiles@1
                  displayName: 'Extract files'
                  inputs:
                      archiveFilePatterns: '$(System.ArtifactsDirectory)/Build-$(Build.SourceBranchName)-$(Build.BuildId).zip'
                      destinationFolder: '$(rootFolder)'
                      cleanDestinationFolder: true

                - script: php bin/console cache:warmup
                  displayName: 'Cache warmup'

                - script: |
                      for i in {1..30}; do
                        nc -z database 3306 && echo "Database is up" && break || echo "Waiting for database..." && sleep 1;
                      done
                  displayName: 'Wait for database to be ready'

                - script: |
                      mysql -h database -u root --skip-ssl -e "GRANT ALL PRIVILEGES ON *.* TO 'app'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
                  displayName: 'Grant permissions to MySQL user'

                - script: php bin/console doctrine:database:create --env=test --if-not-exists
                  displayName: 'Create test database'

                - script: php bin/console doctrine:migrations:migrate --no-interaction --env=test
                  displayName: 'Run migrations'

                - script: php bin/console foundry:load main --no-interaction --env=test
                  displayName: 'Load database fixtures'

                - script: php bin/phpunit -d memory_limit=-1 --stop-on-failure --testdox --coverage-text --coverage-clover=./var/coverage/coverage.xml --log-junit=./var/coverage/tests.xml
                  displayName: 'Run PHPUnit tests'

                - task: PublishTestResults@2
                  displayName: 'Publish Test Results'
                  inputs:
                      testRunner: 'JUnit'
                      testResultsFiles: 'var/coverage/tests.xml'
                      mergeTestResults: 'false'

                - task: PublishCodeCoverageResults@2
                  displayName: 'Publish Code Coverage Results'
                  inputs:
                      codeCoverageTool: 'Cobertura'
                      summaryFileLocation: ./var/coverage/coverage.xml
